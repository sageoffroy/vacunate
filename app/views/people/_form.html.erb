<%= form_with(model: person, id: "new-inscription", local: true, html: { class: "form-horizontal" }) do |form| %>
  <% if person.errors.any? %>

      <script type="text/javascript">
        window.onload = function() {
          toastr['error']('Uno o más campos tienen errores, corrígelos y vuelve a intentarlo');
          <% person.errors.messages.each do |key_p, message| %>

            <% key = key_p.to_s.delete_prefix(':') %>
            <% if Person.columns_hash[key].nil? %>
              <% key = key+"_id" %>
            <% end %>
            var element = document.getElementById("person_<%= key%>");
            element.classList.add("is-invalid");
            if ("<%= message[0] %>" != ""){
              var span = document.createElement('span');
              span.className = "invalid-feedback";
              span.append("<%= message[0] %>");
              element.parentElement.append(span);
            }
          <% end %>
        }
      </script>
  <% end %>

  <div class="row">

    <div class="col-md-12 title-form">
      <hr>
      <div class="alert alert-warning" role="alert">
        Los campos marcados con un "<span style="color:red;">*</span>" son de carácter obligatorio para poder inscribirse.
      </div>

      <p><strong>1- Datos personales</strong></p>
    </div>


    <div class="form-group col-md-6">
      <%= form.label :firstname, "Nombre completo <span style='color:red;'>*</span>".html_safe %>
      <%= form.text_field :firstname, :class => "form-control", :placeholder => "José Luis"  %>
    </div>

    <div class="form-group col-md-6">
      <%= form.label :lastname, "Apellido/s  <span style='color:red;'>*</span>".html_safe %>
      <%= form.text_field :lastname, :class => "form-control", :placeholder => "Gonzalez"  %>
    </div>
    <div class="form-group col-md-6">
      <%= form.label :dni, "Número de documento  <span style='color:red;'>*</span>".html_safe %>
      <%= form.text_field :dni, :class => "form-control", :placeholder=>"12345678"%>
    </div>
    <div class="form-group col-md-6">
      <%= form.label :dni_sex, "Sexo que figura en el DNI  <span style='color:red;'>*</span>".html_safe %>
      <%= form.select :dni_sex, ["Masculino", "Femenino"], {prompt: "Seleccionar"}, {class: "select2 custom-select"} %>
    </div>
    <div class="form-group col-md-6">
      <%= form.label :self_perceived_sex, "Identidad autopercibida"%>
      <%= form.select :self_perceived_sex, ["Varón", "Mujer", "Varón Trans", "Mujer Trans", "Otro"], {prompt: "Seleccionar"}, {class: "select2 form-control"} %>
    </div>
    <div class="form-group col-md-6">
      <%= form.label :birthdate, "Fecha de nacimiento  <span style='color:red;'>*</span>".html_safe %>
      <%= form.text_field :birthdate, hide_label:true, :class => "datepicker form-control", :placeholder => "01/01/1900"%>
    </div>

    <div class="col-md-12 title-form">
      <hr>
      <p><strong>2- Datos de contacto</strong></p>
      <div class="alert alert-warning" role="alert">
        Asegúrate de ingresar los datos de contacto de forma correcta. De otro modo el personal a cargo de informarle sobre su turno de vacunación, no podrá contactarse con usted.
      </div>
    </div>

    <div class="col-md-4 form-group">
       <%= form.label :phone_code, "Código de Área" %>
       <%= form.text_field :phone_code, :placeholder=>"285", data: { toggle: 'tooltip', placement: 'top', original_title: 'Sin el 0' }, :class => "form-control" %>
    </div>
    <div class="col-md-8 form-group">
       <%= form.label :phone, "Número de teléfono" %>
       <%= form.text_field :phone, :placeholder=>"4480200", data: { toggle: 'tooltip', placement: 'top', original_title: 'Si es un celular sin el 15' } , :class => "form-control"%>
    </div>
    <div class="col-md-12 form-group">
      <%= form.label :email, "E-mail" %>
      <%= form.email_field :email, :placeholder=> "contacto@chubut.gov.ar", :class => "form-control" , autocomplete: "email" %>
    </div>

    <div class="col-md-12 title-form">
      <hr>
      <p><strong>3- Datos de tu domicilio</strong></p>
    </div>
    <div class="col-md-12 form-group">
      <%= form.label :locality_id, "Localidad  <span style='color:red;'>*</span>".html_safe %>
      <%= form.collection_select :locality_id, Locality.all, :id, :to_s, {prompt: "Seleccionar localidad"}, {class: "select2 select-field form-control"} %>
    </div>

    <div class="col-md-6 form-group">
      <%= form.label :address_street, "Calle  <span style='color:red;'>*</span>".html_safe %>
      <%= form.text_field :address_street, :placeholder=> "Fontana", :class => "form-control" %>
    </div>

    <div class="col-md-2 col-sm-4 col-xs-4 form-group">
      <%= form.label :address_number, "Nº  <span style='color:red;'>*</span>".html_safe %>
      <%= form.text_field :address_number, :placeholder=> "50", :class => "form-control" %>
    </div>

    <div class="col-md-2 col-sm-4 col-xs-4 form-group">
      <%= form.label :address_floor, "Piso" %>
      <%= form.text_field :address_floor, :placeholder=> "3", data: { toggle: 'tooltip', placement: 'top', original_title: 'Coloque 0 en caso de vivir en planta baja' }, :class => "form-control" %>
    </div>

    <div class="col-md-2 col-sm-4 col-xs-4 form-group">
      <%= form.label :address_department, "Dpto" %>
      <%= form.text_field :address_department, :placeholder=> "C", :class => "form-control" %>
    </div>

    <div class="col-md-12 title-form">
      <hr>
      <p><strong>4- Indica a que grupo poblacional perteneces</strong></p>
    </div>
    <div class="alert alert-warning" role="alert">
      Los grupos se habilitarán de acuerdo a la Fecha de Nacimiento ingresada.
    </div>
    <div id="birthdate-alert" class="alert alert-danger" role="alert">
      Debes elegir tu Fecha de Nacimiento primero.
    </div>
    <div id="group-danger" class="alert alert-danger" role="alert" style="display: none;">
      Quienes tengan doce años deberán concurrir al vacunatorio con la compañía de un adulto.
    </div>
    <div id="group-3a11" class="alert alert-danger" role="alert" style="display: none;">
      Deben concurrir con libreta de vacunación.
    </div>

    <div class="col-md-6 form-group text-center">
      <%= image_tag "iconos_salud-09.png", style:"max-width:150px;" %><br>
      <%= form.radio_button :population_group, "Tengo entre 3 y 11 años", onchange: "handleChange(this);", class:"population_group"%><br>
      <%= form.label :population_group, "Tengo entre 3 y 11 años" %>
    </div>

    <div class="col-md-6 form-group text-center">
      <%= image_tag "iconos_salud-07.png", style:"max-width:150px;" %><br>
      <%= form.radio_button :population_group, "Tengo entre 12 y 17 (con recomendación de vacuna COVID)", onchange: "handleChange(this);", class:"population_group"%><br>
      <%= form.label :population_group, "Tengo entre 12 y 17 años" %>
    </div>
    <div class="col-md-4 form-group text-center">
      <%= image_tag "iconos_salud-02.png", style:"max-width:150px;" %><br>
      <%= form.radio_button :population_group, "Tengo entre 18 y 59 (con factores de riesgo)", onchange: "handleChange(this);", class:"population_group"%><br>
      <%= form.label :population_group, "Tengo entre 18 y 59 (con factores de riesgo)" %>
    </div>
    <div class="col-md-4 form-group text-center">
      <%= image_tag "iconos_salud-06.png", style:"max-width:150px;" %><br>
      <%= form.radio_button :population_group, "Tengo entre 18 y 59 (sin factores de riesgo)", onchange: "handleChange(this);", class:"population_group"%><br>
      <%= form.label :population_group, "Tengo entre 18 y 59 (sin factores de riesgo)" %>
    </div>

    <div class="col-md-4 form-group text-center">
      <%= image_tag "iconos_salud-01.png", style:"max-width:150px;" %><br>
      <%= form.radio_button :population_group, "Soy mayor de 60 años", onchange: "handleChange(this);", class:"population_group"%><br>
      <%= form.label :population_group, "Soy mayor de 60 años" %>
    </div>
    <div class="col-md-4 form-group text-center">
      <%= image_tag "iconos_salud-03.png", style:"max-width:150px;" %><br>
      <%= form.radio_button :population_group, "Soy personal de salud", onchange: "handleChange(this);", class:"population_group"%><br>
      <%= form.label :population_group, "Soy personal de salud" %>
    </div>

    <div class="col-md-4 form-group text-center">
      <%= image_tag "iconos_salud-05.png", style:"max-width:150px;" %><br>
      <%= form.radio_button :population_group, "Soy personal de seguridad", onchange: "handleChange(this);", class:"population_group"%><br>
      <%= form.label :population_group, "Soy personal de seguridad" %>
    </div>
    <div class="col-md-4 form-group text-center">
      <%= image_tag "iconos_salud-04.png", style:"max-width:150px;" %><br>
      <%= form.radio_button :population_group, "Soy personal docente/auxiliar", onchange: "handleChange(this);", class:"population_group"%><br>
      <%= form.label :population_group, "Soy personal de educación" %>
    </div>

    <div class="col-md-12 title-form">
      <hr>
      <p><strong>5- Indica si tienes una o más patologías</strong></p>
    </div>
    <div class="alert alert-warning" role="alert">
      Al momento de la vacunación, deberá acreditar la condición mediante certificado (papel o virtual), recetas de medicamentos, etc.
    </div>
    <div class="col-md-12 form-group">
      <%= form.check_box :obesity, class: "pathology"%>
      <%= form.label :obesity, "Obesidad" %>
      <%= fa_icon "question-circle", id: "obesity-tooltip", data: { toggle: 'tooltip', placement: 'right', original_title: 'Con IMC mayor a 35 o Puntaje Z mayor a 2' }, style: "display: none;" %>
    </div>
    <div class="col-md-12 form-group">
      <%= form.check_box :diabetes, class: "pathology"%>
      <%= form.label :diabetes, "Diabetes" %>
    </div>
    <div class="col-md-12 form-group">
      <%= form.check_box :chronic_kidney_disease, class: "pathology"%>
      <%= form.label :chronic_kidney_disease, "Enfermedad renal crónica" %>
    </div>
    <div class="col-md-12 form-group">
      <%= form.check_box :cardiovascular_disease, class: "pathology"%>
      <%= form.label :cardiovascular_disease, "Enfermedad cardiovascular" %>
      <%= fa_icon "question-circle", id: "cardiovascular-tooltip", data: { toggle: 'tooltip', placement: 'right', original_title: 'Insuficiencia cardiaca, enfermedad coronaria, valvulopatías, miocardiopatías, hipertensión pulmonar, cardiopatías congénitas con insuficiencia cardiaca y/o cianóticas no corregidas' }, style: "display: none;" %>
    </div>
    <div class="col-md-12 form-group">
      <%= form.check_box :neurological_disease, class: "pathology"%>
      <%= form.label :neurological_disease, "Enfermedad neurológica" %>
    </div>
    <div class="col-md-12 form-group">
      <%= form.check_box :chronic_lung_disease, class: "pathology"%>
      <%= form.label :chronic_lung_disease, "Enfermedad pulmonar crónica" %>
      <%= fa_icon "question-circle", id: "chronic-lung-tooltip", data: { toggle: 'tooltip', placement: 'right', original_title: 'Fibrosis quística, enfermedad intersticial pulmonar, asma grave, requerimiento de oxigeno terapia, Enfermedad grave de la vía area, Hospitalizaciones por asma, Enfermedades neuromusculares con compromiso respiratorio' }, style: "display: none;"%>
    </div>
    <div class="col-md-12 form-group">
      <%= form.check_box :inmunocompromised, class: "pathology"%>
      <%= form.label :inmunocompromised, "Inmunocompromiso" %>
      <%= fa_icon "question-circle", id: "inmunocompromised-tooltip", data: { toggle: 'tooltip', placement: 'right', original_title: 'Oncológicos y oncohematológicos con diagnostico reciente o activa, inmunodeficiencias primarias, personas con enfermedades autoinmunes y/o tratamientos inmunosupresores, inmunomoduladores o biológicos, transplantados, personas que viven con vih independientemente del CD4 y CV' }, style: "display: none;" %>
    </div>

    <div class="col-md-12 title-form">
      <hr>
      <p><strong>6- Indica si tienes Certificado Único de Discapacidad. (CUD)</strong></p>

    </div>
    <div class="alert alert-warning" role="alert">
      Al momento de la vacunación, deberá presentar su Certificado Único de Discapacidad.
    </div>

    <div class="col-md-12 form-group">
      <%= form.check_box :cud%>
      <%= form.label :cud, "Tengo certificado único de discapacidad" %>
    </div>
    
    <div class="col-md-12 title-form">
      <hr>
      <p><strong>7- Embarazo</strong></p>

    </div>
    <div class="col-md-12 form-group">
      <%= form.check_box :pregnant, class: "pregnant"%>
      <%= form.label :pregnant, "Estoy embarazada" %>
    </div>
    
    <div class="col-md-12 title-form">
      <hr>
      <p><strong>8- Verifica que no eres un robot</strong></p>
    </div>

    <div class="col-md-12 form-group">
      <%= recaptcha_tags :id => "person_recaptcha_id" %>
    </div>

    <%= form.hidden_field :state%>
    <div class="alert alert-danger" role="alert">
      Los datos ingresados en el presente formulario revisten carácter de Declaración Jurada. Cualquier omisión o falsedad provocará el rechazo de la inscripción y la consecuente exclusión del registro, sin perjuicio de las sanciones legales que pudieran corresponder.
    </div>

    <div class="actions">
      <%= form.submit "Inscribirme", :class => "btn btn-primary btn-block", data: { confirm: 'Asegúrese de que los datos de contacto son correctos antes de continuar' } %>
      <a class="btn btn-secondary btn-block mt-3" href="/">VOLVER AL INICIO</a>
    </div>

  </div>

<!-- Modal -->
<div class="modal fade" id="warning-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body">
        La inscripción en el presente formulario no garantiza la inmediata aplicación de la vacuna, y no implica tampoco la reserva de un turno futuro para la colocación de la misma. <br><br>
        La vacunación contra el Covid-19 se realizará en función de la disponibilidad de las dosis y atendiendo a un cronograma desarrollado por el Programa Provincial de Vacunación, en virtud de la priorización de los distintos grupos de riesgo. <br><br>
        Una vez que las dosis estén disponibles, usted recibirá una notificación para concurrir al centro vacunatorio más cercano, donde le será aplicada la  vacuna contra el Covid-19.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Entiendo</button>
      </div>
    </div>
  </div>
</div>


<% end %>
<script type="text/javascript">
  
  $(document).ready(function(){
    if ($('.people.new').length > 0) {

      var sex = $("#person_dni_sex").val();
      checkPregnant(sex);
      var date_str = $("#person_birthdate").val();
      checkAge(date_str);
      
      if ($("#person_population_group_tengo_entre_12_y_17_con_recomendación_de_vacuna_covid")[0].checked) {
        $("#group-danger").show();
        $("#obesity-tooltip").show();
        $("#cardiovascular-tooltip").show();
        $("#chronic-lung-tooltip").show();
        $("#inmunocompromised-tooltip").show();
      } 
      if ($("#person_population_group_tengo_entre_3_y_11_años")[0].checked) {
        $("#group-3a11").show();
      }

      // limpio el date de fecha nac.
      $("#person_birthdate").val('');
      // limpio seleccion de population group
      $('.population_group').prop('checked', false);
      
      $('.pathology').attr('disabled', true);
      $('.pathology').prop('checked', false);

      $("#warning-modal").modal('show');
      
      $("#person_birthdate").on("change", function() {
        var date_str = $("#person_birthdate").val();
        //console.log("La fecha ahora es: " + date_str);
        checkAge(date_str);
      });

      $("#person_dni_sex").on("change", function() {
        var sex = $("#person_dni_sex").val();
        checkPregnant(sex);
        
      });


      $('.population_group').change(function() {
        //console.log($(this).val());
        if ("Tengo entre 18 y 59 (sin factores de riesgo)" === $(this).val()){
          $('.pathology').attr('disabled', true);
          $('.pathology').prop('checked', false);
        }else{
          $('.pathology').attr('disabled', false);
          
        }
      });
    }
  });

  function checkPregnant(sex){
      //console.log( "la persona es "+sex);
      if (sex=="Femenino"){
          $('.pregnant').attr('disabled', false);
      }
      else
      {
          $('.pregnant').attr('disabled', true);

      }
      
          
    }


  function checkAge (age_str){
    $('.population_group').prop('checked', false);
    englishStr = age_str.substr(3, 2)+"/"+age_str.substr(0, 2)+"/"+age_str.substr(6, 4);
    dob = new Date(englishStr);
    var today = new Date();
    var age = Math.floor((today-dob) / (365.25 * 24 * 60 * 60 * 1000));
    if(age_str.length === 0){
      console.log("La fecha de Nacimiento esta vacía");
      $("#birthdate-alert").fadeIn('slow');
      $('.population_group').attr('disabled', true);
    }
    else {
      console.log("Tiene una fecha de nacimiento");
      $("#birthdate-alert").fadeOut('slow');
      $('#group-3a11').fadeOut('slow'); 
      if(age >= 3 && age < 12){
        $('#group-3a11').fadeIn('slow'); 
        $('.population_group').attr('disabled', true);
        $('#person_population_group_tengo_entre_3_y_11_años').attr('disabled', false);
        $('#person_population_group_tengo_entre_3_y_11_años').prop('checked', true);
        $('.pathology').attr('disabled', false);
        $('.pathology').prop('checked', false);

      }else if (age >= 12 && age < 18){
        console.log("Entre 12 y 17");
        // Aca muestro el  mensage de acompañate si tiene 12 años
        if (age == 12)
          $('#group-danger').fadeIn('slow');
        else
          $('#group-danger').fadeOut('slow');

        $('.population_group').attr('disabled', true);
        $('#person_population_group_tengo_entre_12_y_17_con_recomendación_de_vacuna_covid').attr('disabled', false);
        $('#person_population_group_tengo_entre_12_y_17_con_recomendación_de_vacuna_covid').prop('checked', true);
        $('.pathology').attr('disabled', false);
        $('.pathology').prop('checked', false);
      }else if (age >= 18 && age <= 120){
        console.log("Mayor o igual a 18");
        $('.population_group').attr('disabled', false);
        $('.pathology').prop('checked', false);
        $('#person_population_group_tengo_entre_12_y_17_con_recomendación_de_vacuna_covid').attr('disabled', true);
        $('#person_population_group_tengo_entre_3_y_11_años').attr('disabled', true);
        $('#person_population_group_soy_mayor_de_60_años').attr('disabled', true);
        if (age >= 60){
          $('#person_population_group_soy_mayor_de_60_años').attr('disabled', false);
          $('#person_population_group_soy_mayor_de_60_años').prop('checked', true);
          $('.pathology').prop('checked', false);
          $('.pathology').attr('disabled', false);
        }else if (age>=18 && age<60){
          $('#person_population_group_tengo_entre_18_y_59_sin_factores_de_riesgo').prop('checked', true);
          $('.pathology').attr('disabled', true);
          $('.pathology').prop('checked', false);
        }
      }else {
        console.log("No entra en los grupos permitidos");
        toastr['error']('La fecha de ingresada no corresponde a ninguno de los grupos poblaciones permitidos');
        $('.population_group').attr('disabled', true);
        
      }
    }
  }



  function handleChange(src) {

    if (src.value === "Tengo entre 12 y 17 (con recomendación de vacuna COVID)"){
      $('#group-danger').fadeIn('slow');   
      $('#obesity-tooltip').fadeIn('slow');  
      $('#cardiovascular-tooltip').fadeIn('slow'); 
      $('#chronic-lung-tooltip').fadeIn('slow'); 
      $('#inmunocompromised-tooltip').fadeIn('slow'); 

    }else{

      $('#group-danger').fadeOut('slow');   
      $('#obesity-tooltip').fadeOut('slow');
      $('#cardiovascular-tooltip').fadeOut('slow');
      $('#chronic-lung-tooltip').fadeOut('slow');
      $('#inmunocompromised-tooltip').fadeOut('slow'); 
    }
      

  }
      
</script>
